<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GanadoBravo ‚Äî Evaluaci√≥n IA</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#0b1320;--muted:#6b7280;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;--ring:#111;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:980px;margin:24px auto;padding:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.06);padding:16px}
    h1{font-size:24px;margin:0 0 12px;text-align:center}
    label{font-weight:600;display:block;margin:12px 0 6px}
    select,input[type=file]{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    button{width:100%;padding:14px 16px;border:0;border-radius:999px;background:#16a34a;color:#fff;font-weight:800;font-size:20px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .mt{margin-top:16px}
    .hidden{display:none!important}
    .error{color:#b91c1c;margin-top:12px;font-weight:600}
    pre{background:#0b1020;color:#e5e7eb;padding:12px;border-radius:12px;overflow:auto;max-height:300px}
    .tag{display:inline-block;background:#eef2ff;color:#1e40af;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .muted{color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left}
    .scorePill{display:inline-block;padding:2px 10px;border-radius:999px;color:#fff;font-weight:800}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;margin:4px 6px 0 0;font-size:12px}
    .chip.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .chip.bad{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
    .gauge{width:80px;height:80px;border-radius:50%;display:grid;place-items:center;background:conic-gradient(#16a34a 0deg, #16a34a 0deg, #e5e7eb 0deg)}
    .gauge>div{background:#fff;border-radius:50%;width:58px;height:58px;display:grid;place-items:center;font-weight:900}
    #busyOverlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50;backdrop-filter:saturate(130%) blur(2px)}
    #busyOverlay.show{display:flex}
    .spinner{width:24px;height:24px;border:3px solid #0003;border-top-color:#111;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .warn{background:#fff7ed;border:1px dashed #f59e0b;color:#7c2d12;padding:10px;border-radius:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üêÇ GanadoBravo ‚Äî Evaluaci√≥n IA</h1>

    <div class="card">
      <form id="uploadForm" method="post" action="/api/evaluate" enctype="multipart/form-data">
        <div class="row">
          <div>
            <label for="category">Categor√≠a</label>
            <select id="category" name="category">
              <option value="levante">Levante</option>
              <option value="vaca_flaca">Vaca flaca</option>
              <option value="engorde">Engorde</option>
            </select>
          </div>
          <div>
            <label for="file">Imagen del animal</label>
            <input id="file" name="file" type="file" accept="image/*" capture="environment" required />
          </div>
        </div>

        <div class="mt">
          <label><input type="checkbox" id="pro" /> Pro mode (LiDAR/Depth)</label>
        </div>
        <div id="proPanel" class="hidden mt">
          <div id="proUnsupported" class="warn hidden">Tu tel√©fono no soporta esc√°ner 3D.</div>
          <div id="proControls" class="hidden">
            <button type="button" id="scanBtn" style="margin-bottom:10px">Escanear ahora</button>
            <div class="muted">Si no se abre, usa Polycam/Scaniverse y luego sube el archivo 3D por fuera (por ahora el an√°lisis sigue siendo 2D).</div>
          </div>
          <input type="hidden" name="pro" id="proHidden" value="0" />
        </div>

        <button id="submitBtn" type="submit" class="mt">
          <span id="btnText">Evaluar</span>
          <span id="spinner" class="hidden"> ‚è≥</span>
        </button>
        <p id="error" class="error hidden"></p>
      </form>
    </div>

    <div id="viz" class="card mt hidden"></div>
    <div class="card mt">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span class="tag">JSON</span><span class="muted">Respuesta completa (debug)</span>
      </div>
      <pre id="out">{}</pre>
    </div>
  </div>

  <div id="busyOverlay"><div style="background:#fff;border-radius:16px;padding:14px 16px;display:flex;gap:10px;align-items:center">
    <div class="spinner"></div><div style="font-weight:700">Evaluando‚Ä¶</div>
  </div></div>

<script>
function supports3D(){ const ua=navigator.userAgent||''; const i=/iPhone|iPad/i.test(ua); const a=/Android/i.test(ua); const xr='xr' in navigator; const motion='DeviceMotionEvent' in window; return (i&&motion)||(a&&xr); }
function scoreColor(v){ if(v<5) return '#ef4444'; if(v<6.5) return '#f59e0b'; return '#16a34a'; }
function gaugeHTML(score){
  const deg = Math.max(0, Math.min(360, (score/10)*360));
  return `<div class="gauge" style="background:conic-gradient(#16a34a ${deg}deg, #e5e7eb ${deg}deg 360deg)"><div>${score.toFixed(1)}</div></div>`;
}
function renderViz(data, imgURL){
  const root = document.getElementById('viz'); root.classList.remove('hidden'); root.innerHTML = "";
  const header = document.createElement('div'); header.style.display='flex'; header.style.alignItems='center'; header.style.justifyContent='space-between'; header.style.gap='12px';
  const left = document.createElement('div'); left.style.display='flex'; left.style.gap='12px'; left.style.alignItems='center';
  const img = document.createElement('img'); img.src=imgURL||''; img.width=90; img.height=70; img.style.objectFit='cover'; img.style.borderRadius='12px'; img.style.background='#eee';
  const title = document.createElement('div'); title.innerHTML=`<div style="font-size:18px;font-weight:800;text-transform:uppercase">${(data.category||'').replace('_',' ')}</div>
    <div><span class="tag">${data.mode||'standard'}</span>
    <span class="tag" style="background:#ecfccb;color:#166534;margin-left:6px">${(data.decision?.decision_level||'').replace('_',' ').toLowerCase()}</span></div>
    <div class="muted">${data.decision?.decision_text||''}</div>`;
  left.appendChild(img); left.appendChild(title);
  const right = document.createElement('div'); right.innerHTML = gaugeHTML(Number(data.decision?.global_score||0));
  header.appendChild(left); header.appendChild(right); root.appendChild(header);

  const rubric = data.rubric || {}; const notes = data.rubric_notes || {};
  const order = ["Condici√≥n corporal (BCS)","Conformaci√≥n general","L√≠nea dorsal","Angulaci√≥n costillar","Profundidad de pecho","Aplomos (patas)","Lomo","Grupo / muscling posterior","Balance anterior‚Äìposterior","Ancho tor√°cico","Inserci√≥n de cola"];
  const table = document.createElement('table'); table.className='table mt';
  table.innerHTML = "<thead><tr><th>M√©trica</th><th>Score</th><th>Obs</th></tr></thead>";
  const tb = document.createElement('tbody');
  order.forEach(k=>{
    const v = Number(rubric[k] ?? 0); const c = scoreColor(v);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${k}</td><td><span class="scorePill" style="background:${c}">${v}</span></td><td class="muted">${notes[k]||''}</td>`;
    tb.appendChild(tr);
  });
  table.appendChild(tb); root.appendChild(table);

  const row = document.createElement('div'); row.className='row2 mt';
  const health = document.createElement('div'); health.className='card'; health.style.padding='12px';
  const breed  = document.createElement('div'); breed.className='card'; breed.style.padding='12px';

  const flags = (data.health?.flags||[]);
  const names = ["lesion_cutanea","claudicacion","secrecion_nasal","conjuntivitis","diarrea","dermatitis","lesion_de_pezuna","parasitos_externos","tos"];
  const chips = names.map(n=>`<span class="chip ${flags.includes(n)?'bad':'ok'}">${n.replaceAll('_',' ')}</span>`).join('');
  health.innerHTML = `<div style="font-weight:800;margin-bottom:8px">Salud</div>
    <div>${chips}</div>
    <div class="muted" style="margin-top:8px">${(data.health?.notes||'').trim()||'Sin comentario adicional.'}</div>`;

  breed.innerHTML = `<div style="font-weight:800;margin-bottom:8px">Raza (estimada)</div>
    <div class="muted">${data.breed?.guess || 'Indeterminado'} ‚Äî conf: ${Math.round((data.breed?.confidence??0)*100)}%</div>`;

  row.appendChild(health); row.appendChild(breed); root.appendChild(row);
}

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('uploadForm');
  const btn = document.getElementById('submitBtn');
  const btnText = document.getElementById('btnText');
  const spinner = document.getElementById('spinner');
  const out = document.getElementById('out');
  const errorP = document.getElementById('error');
  const overlay = document.getElementById('busyOverlay');

  const proChk = document.getElementById('pro');
  const proPanel = document.getElementById('proPanel');
  const proHidden = document.getElementById('proHidden');
  const proUnsupported = document.getElementById('proUnsupported');
  const proControls = document.getElementById('proControls');
  const scanBtn = document.getElementById('scanBtn');

  proChk.addEventListener('change', () => {
    proPanel.classList.toggle('hidden', !proChk.checked);
    const ok3d = supports3D();
    proUnsupported.classList.toggle('hidden', ok3d);
    proControls.classList.toggle('hidden', !ok3d);
    proHidden.value = proChk.checked && ok3d ? "1" : "0";
  });

  if (scanBtn){
    scanBtn.addEventListener('click', () => {
      window.location.href = "polycam://";
      setTimeout(()=>{ alert("Si no se abri√≥ tu app de escaneo, instala Polycam/Scaniverse y vuelve a intentar. (Mientras tanto, puedes evaluar en 2D)."); }, 1200);
    });
  }

  form.addEventListener('submit', async function onSubmit(e){
    e.preventDefault();
    errorP.classList.add('hidden'); out.textContent = '{}';
    overlay.classList.add('show');
    btn.disabled = true; spinner.classList.remove('hidden'); btnText.textContent = 'Evaluando...';
    const fd = new FormData(form);
    try{
      const f = document.getElementById('file').files[0];
      const imgPreviewURL = f ? URL.createObjectURL(f) : null;
      const resp = await fetch(form.action, { method:'POST', body: fd });
      const txt = await resp.text();
      let data = null; try{ data = JSON.parse(txt); }catch(_){}
      if(!resp.ok){ throw new Error((data && (data.error||data.detail)) ? (data.error + (data.detail?': '+data.detail:'')) : ('HTTP '+resp.status)); }
      if(!data) throw new Error('Respuesta no-JSON');
      if(data.error) throw new Error(data.error + (data.detail?': '+data.detail:''));
      out.textContent = JSON.stringify(data, null, 2);
      renderViz(data, imgPreviewURL);
    }catch(err){
      console.error(err);
      errorP.textContent = err?.message || String(err);
      errorP.classList.remove('hidden');
    }finally{
      overlay.classList.remove('show');
      btn.disabled = false; spinner.classList.add('hidden'); btnText.textContent = 'Evaluar';
    }
  });
});
</script>
</body>
</html>
