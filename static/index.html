<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GanadoBravo ‚Äî Evaluaci√≥n IA</title>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#111;--muted:#6b7280;--accent:#16a34a;--warn:#c2410c;--err:#b91c1c;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:980px;margin:24px auto;padding:16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 4px 18px rgba(0,0,0,.06);padding:16px}
    h1{font-size:24px;margin:0 0 12px;text-align:center}
    label{font-weight:600;display:block;margin:12px 0 6px}
    select,input[type=file]{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    button{width:100%;padding:14px 16px;border:0;border-radius:999px;background:#16a34a;color:#fff;font-weight:800;font-size:20px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mt{margin-top:16px}
    .hidden{display:none!important}
    .error{color:var(--err);margin-top:12px;font-weight:600}
    pre{background:#0b1020;color:#e5e7eb;padding:12px;border-radius:12px;overflow:auto;max-height:300px}
    .bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar > span{display:block;height:100%;background:#f59e0b}
    .tag{display:inline-block;background:#eef2ff;color:#1e40af;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    #busyOverlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50;backdrop-filter:saturate(130%) blur(2px)}
    #busyOverlay.show{display:flex}
    .spinner{width:24px;height:24px;border:3px solid #0003;border-top-color:#111;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .warn{background:#fff7ed;border:1px dashed #f59e0b;color:#7c2d12;padding:10px;border-radius:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üêÇ GanadoBravo ‚Äî Evaluaci√≥n IA</h1>

    <div class="card">
      <form id="uploadForm" method="post" action="/api/evaluate" enctype="multipart/form-data">
        <div class="row">
          <div>
            <label for="category">Categor√≠a</label>
            <select id="category" name="category">
              <option value="levante">Levante</option>
              <option value="vaca_flaca">Vaca flaca</option>
              <option value="engorde">Engorde</option>
            </select>
          </div>
          <div>
            <label for="file">Imagen del animal</label>
            <input id="file" name="file" type="file" accept="image/*" capture="environment" required />
          </div>
        </div>

        <div class="mt">
          <label><input type="checkbox" id="pro" /> Pro mode (LiDAR/Depth)</label>
        </div>
        <div id="proPanel" class="hidden mt">
          <div id="proUnsupported" class="warn hidden">Tu tel√©fono no soporta esc√°ner 3D.</div>
          <div id="proControls" class="hidden">
            <button type="button" id="scanBtn" style="margin-bottom:10px">Escanear ahora</button>
            <div style="color:var(--muted)">Si no se abre, usa una app externa (Polycam, Scaniverse) y luego sube el archivo 3D por fuera (por ahora el an√°lisis seguir√° siendo 2D).</div>
          </div>
          <input type="hidden" name="pro" id="proHidden" value="0" />
        </div>

        <button id="submitBtn" type="submit" class="mt">
          <span id="btnText">Evaluar</span>
          <span id="spinner" class="hidden"> ‚è≥</span>
        </button>
        <p id="error" class="error hidden"></p>
      </form>
    </div>

    <div id="viz" class="card mt hidden"></div>
    <div class="card mt">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <span class="tag">JSON</span><span class="muted" style="color:var(--muted)">Respuesta completa (debug)</span>
      </div>
      <pre id="out">{}</pre>
    </div>
  </div>

  <div id="busyOverlay"><div style="background:#fff;border-radius:16px;padding:14px 16px;display:flex;gap:10px;align-items:center">
    <div class="spinner"></div><div style="font-weight:700">Evaluando‚Ä¶</div>
  </div></div>

<script>
function supports3D(){
  const ua = navigator.userAgent || '';
  const isIOS = /iPhone|iPad/i.test(ua);
  const isAndroid = /Android/i.test(ua);
  const webxr = 'xr' in navigator;
  const motion = 'DeviceMotionEvent' in window || 'ondevicemotion' in window;
  return (isIOS && motion) || (isAndroid && webxr);
}

function renderViz(data, imgURL){
  const root = document.getElementById('viz');
  root.classList.remove('hidden');
  root.innerHTML = "";

  const head = document.createElement('div');
  head.style.display = 'flex'; head.style.alignItems = 'center'; head.style.gap = '12px';
  const img = document.createElement('img');
  img.src = imgURL || ''; img.width = 90; img.height = 70; img.style.objectFit='cover'; img.style.borderRadius='12px'; img.style.background='#eee';
  const title = document.createElement('div');
  title.innerHTML = `<div style="font-size:18px;font-weight:800;text-transform:uppercase">${(data.category||'').replace('_',' ')}</div>
    <div><span class="tag">${data.mode||'Standard'}</span>
    <span class="tag" style="background:#ecfccb;color:#166534;margin-left:6px">${(data.decision?.decision_level||'').replace('_',' ').toLowerCase()}</span></div>
    <div style="color:var(--muted)">${data.decision?.decision_text||''}</div>`;
  head.appendChild(img); head.appendChild(title);
  root.appendChild(head);

  const grid = document.createElement('div'); grid.className='row2 mt';
  const rubric = data.rubric || {};
  const entries = Object.entries(rubric);
  const half = Math.ceil(entries.length/2);
  const cols = [entries.slice(0,half), entries.slice(half)];
  cols.forEach(col => {
    const colDiv = document.createElement('div');
    col.forEach(([name,val]) => {
      const box = document.createElement('div');
      box.style.marginBottom = '10px';
      box.innerHTML = `<div style="display:flex;justify-content:space-between">
          <div>${name}</div><div>${val}</div></div>
        <div class="bar"><span style="width:${Math.max(0,Math.min(10,Number(val)))*10}%"></span></div>`;
      colDiv.appendChild(box);
    });
    grid.appendChild(colDiv);
  });
  root.appendChild(grid);

  const row = document.createElement('div'); row.className='row2 mt';
  const health = document.createElement('div'); health.className='card'; health.style.padding='12px';
  const breed  = document.createElement('div'); breed.className='card'; breed.style.padding='12px';
  const flags = (data.health?.flags||[]).map(x => x.replaceAll('_',' ')).join(', ');
  health.innerHTML = `<div style="font-weight:800;margin-bottom:8px">Salud</div>
    <div style="color:var(--muted)">${flags || 'Sin banderas'}</div>`;
  breed.innerHTML = `<div style="font-weight:800;margin-bottom:8px">Raza (estimada)</div>
    <div style="color:var(--muted)">${data.breed?.guess || 'Indeterminado'} ‚Äî conf: ${Math.round((data.breed?.confidence??0)*100)}%</div>`;
  row.appendChild(health); row.appendChild(breed);
  root.appendChild(row);
}

document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('uploadForm');
  const btn = document.getElementById('submitBtn');
  const btnText = document.getElementById('btnText');
  const spinner = document.getElementById('spinner');
  const out = document.getElementById('out');
  const errorP = document.getElementById('error');
  const overlay = document.getElementById('busyOverlay');

  const proChk = document.getElementById('pro');
  const proPanel = document.getElementById('proPanel');
  const proHidden = document.getElementById('proHidden');
  const proUnsupported = document.getElementById('proUnsupported');
  const proControls = document.getElementById('proControls');
  const scanBtn = document.getElementById('scanBtn');

  proChk.addEventListener('change', () => {
    proPanel.classList.toggle('hidden', !proChk.checked);
    const ok3d = supports3D();
    proUnsupported.classList.toggle('hidden', ok3d);
    proControls.classList.toggle('hidden', !ok3d);
    proHidden.value = proChk.checked && ok3d ? "1" : "0";
  });

  if (scanBtn){
    scanBtn.addEventListener('click', () => {
      window.location.href = "polycam://";
      setTimeout(()=>{
        alert("Si no se abri√≥ tu app de escaneo, instala Polycam/Scaniverse y vuelve a intentar. (Mientras tanto, puedes evaluar en 2D).");
      }, 1200);
    });
  }

  form.addEventListener('submit', async function onSubmit(e){
    e.preventDefault();
    errorP.classList.add('hidden'); out.textContent = '{}';
    overlay.classList.add('show');
    btn.disabled = true; spinner.classList.remove('hidden'); btnText.textContent = 'Evaluando...';
    const fd = new FormData(form);
    try{
      const f = document.getElementById('file').files[0];
      const imgPreviewURL = f ? URL.createObjectURL(f) : null;
      const resp = await fetch(form.action, { method:'POST', body: fd });
      const txt = await resp.text();
      let data = null; try{ data = JSON.parse(txt); }catch(_){}
      if(!resp.ok){ throw new Error((data && (data.error||data.detail)) ? (data.error + (data.detail?': '+data.detail:'')) : ('HTTP '+resp.status)); }
      if(!data) throw new Error('Respuesta no-JSON');
      if(data.error) throw new Error(data.error + (data.detail?': '+data.detail:''));
      out.textContent = JSON.stringify(data, null, 2);
      renderViz(data, imgPreviewURL);
    }catch(err){
      console.error(err);
      errorP.textContent = err?.message || String(err);
      errorP.classList.remove('hidden');
    }finally{
      overlay.classList.remove('show');
      btn.disabled = false; spinner.classList.add('hidden'); btnText.textContent = 'Evaluar';
    }
  });
});
</script>
</body>
</html>
